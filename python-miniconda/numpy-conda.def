# Filename: numpy-conda.def

# Build an apptainer containing a miniconda-based Python with numpy

Bootstrap: localimage
From: ubuntu_24.04.sif

# The %post section contains the commands to be run during the build process

%post

DEBIAN_FRONTEND=noninteractive apt-get -y update
DEBIAN_FRONTEND=noninteractive apt-get -y upgrade
DEBIAN_FRONTEND=noninteractive apt-get -y install wget

# NOTE there are no "users" in the container; the commands
#      here are effectively run by "root"
mkdir -p /opt/miniconda3


# NOTE uncomment the appropriate version of Miniconda3
# This is for Intel x86_64
#wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /opt/miniconda3/miniconda.sh

# This is for ARM64 aarch64
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-aarch64.sh -O /opt/miniconda3/miniconda.sh

bash /opt/miniconda3/miniconda.sh -b -u -p /opt/miniconda3

rm -f /opt/miniconda3/miniconda.sh

# activate conda
. /opt/miniconda3/bin/activate

# accept Terms Of Service
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r

# install numpy
conda install numpy

%environment

# Cannot source the miniconda "activate" script at runtime,
# so set some miniconda environment variables statically in
# the container.
# The environment variables will be defined in the resulting container.

export PATH=/opt/miniconda3/bin:/opt/miniconda3/condabin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export _CONDA_ROOT=/opt/miniconda3
export CONDA_EXE=/opt/miniconda3/bin/conda
export _CONDA_EXE=/opt/miniconda3/bin/conda
export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
